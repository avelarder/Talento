@model Talento.Models.EditCandidateViewModel

<div class="modal-dialog">
    <div class="modal-content">
        <div class="modal-body" id="edit-position-dialog-body">
            <form id="EditCandidateForm" method="post" action="/Candidate/Edit">
                @Html.ValidationSummary(true, "", new { @class = "text-danger" })
                @Html.AntiForgeryToken()
                <input type="hidden" id="CandidateId" name="CandidateId" value="@Model.CandidateId">
                <input type="hidden" id="Position_Id" name="Position_Id" value="@Model.Position_Id">
                <div class="modal-body">
                    <p><strong>Edit Profile</strong></p>
                    <div class="form-group row">
                        <label for="Email" class="col-md-2 col-form-label">Email</label>
                        <div class="col-md-4">
                            <input disabled class="form-control" type="text" name="Email" id="Email" value="@Model.Email">
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="Name" class="col-md-2 col-form-label">Name</label>
                        <div class="col-md-4">
                            <input class="form-control" type="text" id="Name" name="Name" value="@Model.Name" maxlength="50" data-val="true" required>
                            <span class="field-validation-valid text-danger" data-valmsg-for="Name" data-valmsg-replace="true"></span>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="Competencies" class="col-md-2 col-form-label">Competencies</label>
                        <div class="col-md-4">
                            <textarea class="form-control" rows="6" type="text" id="Competencies" name="Competencies" 
                                      style="resize:none;" maxlength="300" required>@Model.Competencies</textarea>
                        </div>
                    </div>
                    <div class="checkbox">
                        <div class="form-group row">
                            <label class="control-label col-md-2" for="Email">Is Tcs Employee? </label>
                            <div class="col-md-10">

                                @if (Model.IsTcsEmployee.Equals("True"))
                                {
                                    <input class="form-control text-box single-line" data-val="true" id="IsTcsEmployee" name="IsTcsEmployee" type="checkbox" checked />
                                }
                                else
                                {
                                    <input class="form-control text-box single-line" data-val="true" id="IsTcsEmployee" name="IsTcsEmployee" type="checkbox" />
                                }
                                <span class="field-validation-valid text-danger" data-valmsg-for="IsTcsEmployee" data-valmsg-replace="true"></span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group row">
                        <label for="Description" class="col-md-2 col-form-label">Description</label>
                        <div class="col-md-4">
                            <input class="form-control" type="text" id="Description" name="Description" value="@Model.Description"maxlength="300" data-val="true" required >
                            <span class="field-validation-valid text-danger" data-valmsg-for="Description" data-valmsg-replace="true"></span>
                        </div>
                    </div>
                    <div class="form-group row">
                        @Html.Action("Edit", "File", new { candidateId = Model.CandidateId })
                    </div>
                </div>
                <div class="pmd-modal-action pmd-modal-bordered text-right">
                    <button data-dismiss="modal" class="btn pmd-btn-flat pmd-ripple-effect btn-primary" type="button">Cancel</button>
                    <input type="button" id="buttoneditprofile" class="btn pmd-btn-flat pmd-ripple-effect btn-default" value="Save" />
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    (function ($) {
        function addFile() {
            var formData = new FormData();
            formData.append('image', $('input[type=file]')[0].files[0]);
            formData.append('candidateId', @Model.CandidateId);
            $.ajax({
                type: "POST",
                url: '/File/Add',
                data: formData,
                dataType: 'json',
                contentType: false,
                processData: false,
                success: function (response) {
                    updatelist();
                },
                error: function (error) {
                    //Error is good enough because the result is always empty
                    updatelist();
                }

            });
        }
        function deleteFile(filename) {
            var formData = new FormData();
            $.ajax({
                type: "POST",
                url: '/File/DeleteEdit',
                data: "filename=" + filename + "&candidateid="+@Model.CandidateId,
                success: function (response) {
                    updatelist();
                },
                error: function (error) {
                    updatelist();
                }

            });
        }

        function buildFileList(filelist) {

            $("#fileListDiv").empty();
            for (i = 0; i < filelist.length; i++) {
                $("#fileListDiv").append("<p id='file_" + filelist[i] + "'>" +
                    "<i class='material-icons'>insert_drive_file</i>" +
                    "<span>" + filelist[i].FileName + "</span>" +
                    "<i class='delete-file material-icons' style='cursor:pointer' data-file='" + filelist[i].FileName + "'>delete</i>" +
                    "</p>");
            }
        }

        $('#edit-position-dialog').on('hidden.bs.modal', function () {
            console.log("Dirty Sanchez");
            $("body").removeClass("modal-open");
            $.ajax({
                type: "POST",
                url: '/File/EmptyList',
                dataType: 'json',
                success: function (response) {
                    buildFileList(response);
                },
                error: function (error) {
                    //alert("holi2");
                }
            });
            buildFileList();
            setTimeout(stopUpdate, 2000);
        });

        function updatelist() {
            $.ajax({
                type: "POST",
                url: '/File/ListCurrentFiles/',
                dataType: 'json',
                success: function (response) {
                    buildFileList(response);
                },
                error: function (error) {
                    //alert("holi2");
                }
            });
        }
        $(document).ready(function () {
            updatelist();
            $(".btn-modal").on("click", function () {
                $("#Position_Id").val(($(this).attr("name")).split("-")[1]);
            });
            console.log("trigger 1");
            $('#edit-position-dialog').on("change",'#Files', function () {
                console.log('accc');
                addFile();
            });
            $("#fileListDiv").on("click", ".delete-file", function () {
                deleteFile($(this).attr('data-file'));
            });
                        
            $("#buttoneditprofile").click(function (evt) {
                evt.preventDefault();
                var $form = $('#EditCandidateForm');
                if ($form.valid()) {
                    $("#complete-dialog").modal("hide");
                    toastr.options = {
                        "debug": false,
                        "positionClass": "toast-top-center",
                        "onclick": null,
                        "fadeIn": 500,
                        "fadeOut": 2000,
                        "timeOut": 6000,
                        "extendedTimeOut": 2000
                    }
                    toastr.success("Profile has been edited successfully.");
                    setTimeout(function () {  }, 2500)
                    $form.submit();
                } else {
                    
                    return;

                }
            });
        });
    }(jQuery));

</script>
